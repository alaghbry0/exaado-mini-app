'use strict';

// ุชุนุฑูู ุงููุชุบูุฑุงุช ุงูุนุงูุฉ
let tg = null;
let telegramId = null;

// ุฏุงูุฉ ุนุงูุฉ ูุชูููุฐ ุทูุจุงุช AJAX
function performAjaxRequest({ url, method = "GET", data = null, onSuccess, onError }) {
    $.ajax({
        url,
        type: method,
        contentType: "application/json",
        data: data ? JSON.stringify(data) : null,
        success: onSuccess,
        error: onError,
    });
}

// ุงูุชููุฆุฉ ุงูุฃุณุงุณูุฉ ูุชุทุจูู Telegram WebApp
function initializeTelegramWebApp() {
    try {
        tg = window.Telegram?.WebApp;

        if (!tg) {
            handleError("Telegram WebApp API ุบูุฑ ูุชููุฑ. ูุฑุฌู ูุชุญ ุงูุชุทุจูู ูู ุฏุงุฎู Telegram.");
            return;
        }

        // ุชุฃููุฏ ุงูุชููุฆุฉ
        tg.ready(() => {
            console.log("Telegram WebApp ุฌุงูุฒ.");
            const userData = tg.initDataUnsafe?.user;

            if (userData?.id) {
                telegramId = userData.id;
                const username = userData.username || "Unknown User";
                const fullName = `${userData.first_name || ''} ${userData.last_name || ''}`.trim();

                console.log("Telegram ID:", telegramId);
                console.log("Username:", username);
                console.log("Full Name:", fullName);

                updateUserUI(fullName, username);
                sendTelegramIDToServer(telegramId, username);
            } else {
                handleError("ุจูุงูุงุช ุงููุณุชุฎุฏู ุบูุฑ ูุชููุฑุฉ ุจุนุฏ ุงูุชููุฆุฉ.");
            }
        });
    } catch (error) {
        handleError("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชููุฆุฉ ุงูุชุทุจูู: " + error.message);
    }
}

// ุชุญุฏูุซ ูุงุฌูุฉ ุงููุณุชุฎุฏู
function updateUserUI(fullName, username) {
    const userNameElement = document.getElementById("user-name");
    const userUsernameElement = document.getElementById("user-username");

    if (userNameElement) userNameElement.textContent = fullName;
    if (userUsernameElement) userUsernameElement.textContent = username;
}

// ุฅุฑุณุงู Telegram ID ุฅูู ุงูุฎุงุฏู
function sendTelegramIDToServer(telegramId, username) {
    performAjaxRequest({
        url: "/api/verify",
        method: "POST",
        data: { telegram_id: telegramId, username },
        onSuccess: (response) => console.log("ุชู ุงูุชุญูู ูู Telegram ID:", response),
        onError: (error) => console.error("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุญูู ูู Telegram ID:", error),
    });
}

// ุงูุชุนุงูู ูุน ุงูุฃุฎุทุงุก
function handleError(message) {
    console.error(message);
    alert(message);
}

// ุงูุชุญูู ูู ุจูุฆุฉ Telegram
function checkTelegramEnvironment() {
    console.log("ุงูุชุญูู ูู ุจูุฆุฉ Telegram WebApp...");
    if (!window.Telegram || !window.Telegram.WebApp) {
        handleError("Telegram WebApp ุบูุฑ ูุชููุฑ. ูุฑุฌู ูุชุญ ุงูุชุทุจูู ูู ุฏุงุฎู Telegram.");
        return false;
    }
    console.log("Telegram.WebApp ูุชููุฑ. ุงูุชุทุจูู ูุนูู ุฏุงุฎู Telegram WebApp.");
    return true;
}

// ุจุฏุก ุงูุชููุฆุฉ ุนูุฏ ุชุญููู ุงูุตูุญุฉ
document.addEventListener("DOMContentLoaded", function () {
    if (checkTelegramEnvironment()) {
        initializeTelegramWebApp();
    }
});

$(document).ready(function () {

    var body = $('body');
    var bodyParent = $('html');

    /* page load as iframe */
    if (self !== top) {
        body.addClass('iframe');
    } else {
        body.removeClass('iframe');
    }

    /* menu open close */
    $('.menu-btn').on('click', function () {
        if (body.hasClass('menu-open') === true) {
            body.removeClass('menu-open');
            bodyParent.removeClass('menu-open');
        } else {
            body.addClass('menu-open');
            bodyParent.addClass('menu-open');
        }

        return false;
    });

    body.on("click", function (e) {
        if (!$('.sidebar').is(e.target) && $('.sidebar').has(e.target).length === 0) {
            body.removeClass('menu-open');
            bodyParent.removeClass('menu-open');
        }

        return true;
    });



    /* menu style switch */
    $('#menu-pushcontent').on('change', function () {
        if ($(this).is(':checked') === true) {
            body.addClass('menu-push-content');
            body.removeClass('menu-overlay');
        }

        return false;
    });

    $('#menu-overlay').on('change', function () {
        if ($(this).is(':checked') === true) {
            body.removeClass('menu-push-content');
            body.addClass('menu-overlay');
        }

        return false;
    });

// ุจูุงูุงุช ุงููุณุชุฎุฏู (ุฃูุซูุฉ)
if (telegramId) {
    const userNameElement = document.getElementById("user-name");
    const userUsernameElement = document.getElementById("user-username");
    const avatarElement = document.querySelector(".avatar img");

    console.log("Telegram ID is valid. Proceeding to display user data...");

    if (userNameElement) {
        userNameElement.textContent = tg.initDataUnsafe?.user?.first_name || "Unknown";
    }
    if (userUsernameElement) {
        userUsernameElement.textContent = tg.initDataUnsafe?.user?.username || "Unknown User";
    }
    if (avatarElement) {
        avatarElement.src = tg.initDataUnsafe?.user?.photo_url || "assets/img/default-profile.jpg"; // ุตูุฑุฉ ุงูุชุฑุงุถูุฉ
    }
} else {
    console.error("Telegram ID is not defined. Make sure the WebApp is initialized properly.");
    alert("ูุฑุฌู ูุชุญ ุงูุชุทุจูู ูู ุฏุงุฎู Telegram.");
}



    /* back page navigation */
    $('.back-btn').on('click', function () {
        window.history.back();

        return false;
    });

    /* Filter button */
    $('.filter-btn').on('click', function () {
        if (body.hasClass('filter-open') === true) {
            body.removeClass('filter-open');
        } else {
            body.addClass('filter-open');
        }

        return false;
    });
    $('.filter-close').on('click', function () {
        if (body.hasClass('filter-open') === true) {
            body.removeClass('filter-open');
        }
    });

    /* scroll y limited container height on page  */
    var scrollyheight = Number($(window).height() - $('.header').outerHeight() - $('.footer-info').outerHeight()) - 40;
    $('.scroll-y').height(scrollyheight);

});


$(window).on('load', function () {
    setTimeout(function () {
        $('.loader-wrap').fadeOut('slow');
    }, 500);

    /* coverimg */
    $('.coverimg').each(function () {
        var imgpath = $(this).find('img');
        $(this).css('background-image', 'url(' + imgpath.attr('src') + ')');
        imgpath.hide();
    })

    /* main container minimum height set */
    if ($('.header').length > 0 && $('.footer-info').length > 0) {
        var heightheader = $('.header').outerHeight();
        var heightfooter = $('.footer-info').outerHeight();

        var containerheight = $(window).height() - heightheader - heightfooter - 2;
        $('.main-container ').css('min-height', containerheight);
    }


    /* url path on menu */
    var path = window.location.href; // because the 'href' property of the DOM element is the absolute path
    $(' .main-menu ul a').each(function () {
        if (this.href === path) {
            $(' .main-menu ul a').removeClass('active');
            $(this).addClass('active');
        }
    });

});

$(window).on('scroll', function () {


    /* scroll from top and add class */
    if ($(document).scrollTop() > '10') {
        $('.header').addClass('active');
    } else {
        $('.header').removeClass('active');
    }
});


$(window).on('resize', function () {
    /* main container minimum height set */
    if ($('.header').length > 0 && $('.footer-info').length > 0) {
        var heightheader = $('.header').outerHeight();
        var heightfooter = $('.footer-info').outerHeight();

        var containerheight = $(window).height() - heightheader - heightfooter;
        $('.main-container ').css('min-height', containerheight);
    }
});

// ุฏุงูุฉ ุงูุงุดุชุฑุงู
function subscribe(subscriptionType) {
    console.log("ุจุฏุก ุนูููุฉ ุงูุงุดุชุฑุงู...");

    if (!tg) {
        handleError("Telegram WebApp API ุบูุฑ ูููุฃ. ูุฑุฌู ูุชุญ ุงูุชุทุจูู ูู ุฏุงุฎู Telegram.");
        return;
    }

    if (!telegramId) {
        handleError("Telegram ID ุบูุฑ ูุชููุฑ.");
        return;
    }

    const subscriptionData = {
        telegram_id: telegramId,
        subscription_type: subscriptionType,
    };

    console.log("ุงูุจูุงูุงุช ุงููุฑุณูุฉ ููุงุดุชุฑุงู:", subscriptionData);

    // ุฅุฑุณุงู ุงูุจูุงูุงุช ุฅูู API
    performAjaxRequest({
        url: "https://exaado-mini-app-c04ea61e41f4.herokuapp.com/api/subscribe",
        method: "POST",
        data: subscriptionData,
        onSuccess: (response) => {
            console.log("ุชู ุงูุงุดุชุฑุงู ุจูุฌุงุญ:", response);
            alert(`๐ ${response.message}`);
        },
        onError: (error) => {
            console.error("ุฎุทุฃ ุฃุซูุงุก ุนูููุฉ ุงูุงุดุชุฑุงู:", error);
            handleError("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุดุชุฑุงู. ูุฑุฌู ุงููุญุงููุฉ ูุงุญููุง.");
        },
    });
}

// ุฏุงูุฉ ุงูุชุฌุฏูุฏ
function renewSubscription(subscriptionType) {
    console.log("ุจุฏุก ุนูููุฉ ุงูุชุฌุฏูุฏ...");

    if (!tg) {
        handleError("Telegram WebApp API ุบูุฑ ูููุฃ. ูุฑุฌู ูุชุญ ุงูุชุทุจูู ูู ุฏุงุฎู Telegram.");
        return;
    }

    if (!telegramId) {
        handleError("Telegram ID ุบูุฑ ูุชููุฑ.");
        return;
    }

    const renewalData = {
        telegram_id: telegramId,
        subscription_type: subscriptionType,
    };

    console.log("ุงูุจูุงูุงุช ุงููุฑุณูุฉ ููุชุฌุฏูุฏ:", renewalData);

    // ุฅุฑุณุงู ุจูุงูุงุช ุงูุชุฌุฏูุฏ ุฅูู API
    performAjaxRequest({
        url: "https://exaado-mini-app-c04ea61e41f4.herokuapp.com/api/renew",
        method: "POST",
        data: renewalData,
        onSuccess: (response) => {
            console.log("ุชู ุงูุชุฌุฏูุฏ ุจูุฌุงุญ:", response);
            alert(`๐ ${response.message}`);
        },
        onError: (error) => {
            console.error("ุฎุทุฃ ุฃุซูุงุก ุนูููุฉ ุงูุชุฌุฏูุฏ:", error);
            handleError("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุฌุฏูุฏ. ูุฑุฌู ุงููุญุงููุฉ ูุงุญููุง.");
        },
    });
}


// ุฏุงูุฉ ุงูุชุญูู ูู ุงูุงุดุชุฑุงู
function checkSubscription(telegramId) {
    if (!telegramId) {
        handleError("Telegram ID ุบูุฑ ูุชููุฑ. ูุง ูููู ุงูุชุญูู ูู ุงูุงุดุชุฑุงู.");
        return;
    }

    performAjaxRequest({
        url: `/api/check_subscription?telegram_id=${telegramId}`,
        method: "GET",
        onSuccess: (response) => {
            console.log("ุชูุงุตูู ุงูุงุดุชุฑุงู:", response.subscriptions);
        },
        onError: (error) => {
            console.error("ุฎุทุฃ ุฃุซูุงุก ุงูุชุญูู ูู ุงูุงุดุชุฑุงู:", error);
            handleError("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุญูู ูู ุงูุงุดุชุฑุงู. ูุฑุฌู ุงููุญุงููุฉ ูุงุญููุง.");
        },
    });
}

// ุชูุญูุฏ ุฑุจุท ุงูุฃุญุฏุงุซ ูุฌููุน ุงูุฃุฒุฑุงุฑ
function bindButtonEvents() {
    document.querySelectorAll(".subscribe-btn").forEach((button) => {
        button.addEventListener("click", function () {
            const subscriptionType = this.getAttribute("data-subscription");
            if (!subscriptionType) {
                handleError("ููุน ุงูุงุดุชุฑุงู ุบูุฑ ูุญุฏุฏ.");
                return;
            }
            subscribe(subscriptionType);
        });
    });

    document.querySelectorAll(".renew-btn").forEach((button) => {
        button.addEventListener("click", function () {
            const subscriptionType = this.getAttribute("data-subscription");
            if (!subscriptionType) {
                handleError("ููุน ุงูุชุฌุฏูุฏ ุบูุฑ ูุญุฏุฏ.");
                return;
            }
            renewSubscription(subscriptionType);
        });
    });
}

// ุชููุฆุฉ ุงูุฃุญุฏุงุซ ุนูุฏ ุชุญููู ุงูุตูุญุฉ
document.addEventListener("DOMContentLoaded", function () {
    bindButtonEvents();
});


// ุงูุชุนุงูู ูุน ุงูุฃุญุฏุงุซ ุนูุฏ ุชุญููู ุงูุตูุญุฉ
ocument.addEventListener("DOMContentLoaded", function () {
    console.log("DOM fully loaded and parsed.");

// ุชููุฆุฉ ุงูุฃุญุฏุงุซ ููุฃุฒุฑุงุฑ
    bindButtonEvents();

// ุงูุชุญูู ูู Telegram WebApp
    if (checkTelegramEnvironment()) {
        initializeTelegramWebApp();
    } else {
        console.warn("Application running outside Telegram WebApp.");
    }
});

// ุฏูุงู ุงูุชุญูู ุจุดุฑูุท ุงูุชุญููู
function toggleLoader(visible) {
    const loader = document.getElementById("loader");
    if (loader) {
        loader.style.display = visible ? "block" : "none";
    } else {
        console.warn("Loader element not found in the DOM.");
    }
}
